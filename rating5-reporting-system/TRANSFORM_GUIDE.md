# Инструкция по трансформации данных в Rating5_OPS

## Что делает этот скрипт?

Скрипт `TransformData.gs` работает **внутри одной таблицы** Rating5_OPS и переносит данные из старой структуры (вкладка "Клиенты" с 30 колонками) в новую оптимизированную структуру (вкладки Clients и Articles).

---

## Пошаговая инструкция

### ШАГ 1: Откройте таблицу Rating5_OPS

Откройте вашу таблицу:
```
https://docs.google.com/spreadsheets/d/1MQEz9s89e7ev7VilI4pBoeb9irZZdK6d/edit
```

### ШАГ 2: Откройте редактор Apps Script

1. В меню таблицы выберите: **Расширения → Apps Script**
2. Откроется редактор кода

### ШАГ 3: Создайте файл TransformData.gs

1. В редакторе Apps Script нажмите **+ (Добавить файл)** → **Скрипт**
2. Назовите файл: `TransformData`
3. Скопируйте **весь код** из файла `apps-script/TransformData.gs` и вставьте в редактор
4. Нажмите **Ctrl+S** (или иконку дискеты) для сохранения

### ШАГ 4: Запустите миграцию

1. В верхней части редактора найдите выпадающий список с функциями
2. Выберите функцию: **`transformOldDataToNew`**
3. Нажмите кнопку **▶ Выполнить**

### ШАГ 5: Предоставьте разрешения (только при первом запуске)

При первом запуске Google попросит разрешения:

1. Появится окно: **"Требуется авторизация"** → нажмите **Проверить разрешения**
2. Выберите ваш Google аккаунт
3. Появится предупреждение **"Это приложение не проверено Google"**:
   - Нажмите **"Дополнительные настройки"** (внизу слева)
   - Нажмите **"Перейти на страницу Rating5_OPS (небезопасно)"**
4. Нажмите **"Разрешить"**

### ШАГ 6: Дождитесь завершения

- Скрипт запустится и отобразит прогресс в логах (внизу редактора)
- По завершении появится всплывающее окно с результатами:
  ```
  ✅ Миграция завершена!

  Перенесено клиентов: 50
  Создано записей артикулов: 0

  Проверьте вкладки Clients и Articles
  ```

### ШАГ 7: Проверьте результаты

1. Вернитесь в таблицу Rating5_OPS
2. Откройте вкладку **Clients** — должны появиться данные клиентов
3. Откройте вкладку **Articles** — пока будет пустая (артикулы мигрируем отдельно)

---

## Дополнительные функции

### Миграция артикулов (если есть вкладка "Артикулы")

Если у вас в таблице есть вкладка **"Артикулы"** со списком артикулов по клиентам:

1. В редакторе Apps Script выберите функцию: **`migrateArticlesFromOldSheet`**
2. Нажмите **▶ Выполнить**
3. Проверьте вкладку **Articles** — должны появиться артикулы с привязкой к клиентам

**Ожидаемая структура вкладки "Артикулы":**
- Колонка A: Имя клиента (должно совпадать с именем в "Клиенты")
- Колонка B: Артикул
- Колонка C: Название товара (опционально)

### Проверка корректности миграции

Для проверки качества миграции:

1. В редакторе Apps Script выберите функцию: **`validateMigration`**
2. Нажмите **▶ Выполнить**
3. Появится окно со статистикой:
   - Количество клиентов и артикулов
   - Наличие дубликатов
   - Процент клиентов с заполненными папками Drive

---

## Что делает скрипт?

### Трансформация данных клиентов

**Из старой вкладки "Клиенты" (30 колонок):**
- Колонка B (Client Name) → Clients.ClientName
- Колонка C (Статус) → Clients.Status ("В работе" → active, "Потеря" → inactive)
- Колонка P (Папка клиента) → Clients.DriveFolderID (извлекается ID из URL)
- Колонка Q (Отчет клиента) → Clients.ReportSheetID (извлекается ID из URL)
- Колонка S (Скриншоты) → Clients.ScreenshotsFolderID (извлекается ID из URL)

**В новую вкладку Clients (8 колонок):**
```
ClientID | ClientName | Status | DriveFolderID | ScreenshotsFolderID | ReportSheetID | CreatedAt | UpdatedAt
CL0001   | ООО СТЕУС  | active | 16u_lM1KV... | 183JHWHk... | 1U81k4GNL...  | 2025-11-29 | 2025-11-29
```

### Извлечение ID из URL

Скрипт автоматически извлекает ID из различных форматов URL:

**Google Drive Folders:**
```
https://drive.google.com/drive/folders/16u_lM1KVwVNkXzg2iM7resjB38WfY5OS
                                         ↑
                                   Извлекается ID
```

**Google Sheets:**
```
https://docs.google.com/spreadsheets/d/1U81k4GNLplpEMn1Yxp7bpJLl_EQO_Idp/edit
                                        ↑
                                  Извлекается ID
```

---

## Решение проблем

### Ошибка: "Вкладка 'Clients' не найдена"

**Причина:** Вы не запустили сначала `SetupSheets.gs`

**Решение:**
1. Откройте файл `SetupSheets.gs` в Apps Script
2. Запустите функцию `setupSheets()`
3. Затем повторите миграцию с `transformOldDataToNew()`

### Ошибка: "Не найдена вкладка со старыми данными"

**Причина:** Скрипт ищет вкладку с именем "Клиенты", "Clients_OLD" или "Отчет автоматизация"

**Решение:**
1. Переименуйте вашу старую вкладку в "Клиенты"
2. Или измените массив `possibleNames` в коде функции `readOldClientsSheet()`

### Пустая вкладка Articles после миграции

**Это нормально!** Основная миграция переносит только клиентов.

Артикулы нужно мигрировать отдельно функцией `migrateArticlesFromOldSheet()` (если у вас есть вкладка "Артикулы").

Если артикулов нет в отдельной вкладке, они будут добавляться автоматически Chrome расширением при работе.

---

## Следующие шаги

После успешной миграции данных:

1. ✅ Проверьте корректность данных во вкладках Clients и Articles
2. ✅ Запустите валидацию через `validateMigration()`
3. ⏭️ Переходите к **Phase 2**: Установка Apps Script модулей (ReportGenerator.gs, DataValidator.gs)
4. ⏭️ Затем **Phase 3**: Интеграция Chrome Extension с новой структурой таблицы

---

## Вопросы?

Если что-то пошло не так:
1. Откройте **Apps Script → Журнал выполнения** (иконка часов слева)
2. Посмотрите подробные логи выполнения
3. Найдите строку с ошибкой и сообщите мне
