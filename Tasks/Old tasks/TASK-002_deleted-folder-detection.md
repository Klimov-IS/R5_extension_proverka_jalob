# TASK-002: Files Uploaded to Deleted Folders (Trash)

## Status
‚úÖ Implementation Complete - Ready for Testing

## Priority
Critical

## Reported Date
2025-12-01

## Implementation Date
2025-12-01

## Related Tasks
- TASK-001 (Duplicate folder creation) - **Root cause —Å–≤—è–∑–∞–Ω–∞ —Å —ç—Ç–æ–π –∑–∞–¥–∞—á–µ–π**

---

## Problem Description

### Reproduction Steps
1. –ó–∞–ø—É—Å—Ç–∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –∫–∞–±–∏–Ω–µ—Ç–∞ ‚Üí —Å–æ–∑–¥–∞–ª–∏—Å—å –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ + —Å–∫—Ä–∏–Ω—à–æ—Ç—ã –≤ Drive
2. **–û–±–Ω–∞—Ä—É–∂–∏–ª–∏ –æ—à–∏–±–∫—É** ‚Üí —É–¥–∞–ª–∏–ª–∏ –∑–∞–ø–∏—Å–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
3. **–£–¥–∞–ª–∏–ª–∏ –ø–∞–ø–∫—É —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤** –Ω–∞ Google Drive (–ø–∞–ø–∫–∞ –ø–æ–ø–∞–ª–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É)
4. –ó–∞–ø—É—Å—Ç–∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É **–∑–∞–Ω–æ–≤–æ** ‚Üí –∑–∞–ø–∏—Å–∏ –¥–æ–±–∞–≤–∏–ª–∏—Å—å, –Ω–æ **—Å–∫—Ä–∏–Ω—à–æ—Ç—ã –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å –≤ –ø–∞–ø–∫—É –∫–æ—Ç–æ—Ä–∞—è –≤ –∫–æ—Ä–∑–∏–Ω–µ**
5. –£–¥–∞–ª–∏–ª–∏ –≤—Å–µ —Å–Ω–æ–≤–∞, **–æ—á–∏—Å—Ç–∏–ª–∏ –∫–æ—Ä–∑–∏–Ω—É**, —É–¥–∞–ª–∏–ª–∏ –∑–∞–ø–∏—Å–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
6. –ó–∞–ø—É—Å—Ç–∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É —Ç—Ä–µ—Ç–∏–π —Ä–∞–∑ ‚Üí **–ù–ò–ß–ï–ì–û –Ω–µ –¥–æ–±–∞–≤–∏–ª–æ—Å—å** (–Ω–∏ –∑–∞–ø–∏—Å–µ–π, –Ω–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤)

### Current Behavior
- –°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π ID –ø–∞–ø–∫–∏**, –¥–∞–∂–µ –µ—Å–ª–∏ –ø–∞–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É
- –ü–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã —Å–∏—Å—Ç–µ–º–∞ **–Ω–µ —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é –ø–∞–ø–∫—É**, –ø–æ—Ç–æ–º—É —á—Ç–æ –≤ –∫–µ—à–µ –æ—Å—Ç–∞–ª—Å—è ID —É–¥–∞–ª–µ–Ω–Ω–æ–π –ø–∞–ø–∫–∏
- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ **–º–æ–ª—á–∞ –ø—Ä–æ–≤–∞–ª–∏–≤–∞–µ—Ç—Å—è** –±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π

### Expected Behavior
1. –ü–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π —Ñ–∞–π–ª–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —á—Ç–æ **–ø–∞–ø–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –≤ –∫–æ—Ä–∑–∏–Ω–µ**
2. –ï—Å–ª–∏ –ø–∞–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∞ ‚Üí **–æ—á–∏—Å—Ç–∏—Ç—å –∫–µ—à** –¥–ª—è —ç—Ç–æ–π –ø–∞–ø–∫–∏
3. **–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø–∞–ø–∫—É** –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É
4. –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –¥–æ–ª–∂–Ω–∞ **–ª–∏–±–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è, –ª–∏–±–æ –≤—ã–¥–∞—Ç—å –æ—à–∏–±–∫—É**

---

## Root Cause Analysis

### Pre-Task Diagnostics Required
‚ö†Ô∏è **–í–ê–ñ–ù–û:** –ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–≤–µ—Å—Ç–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É:

1. **google-drive-api.js**
   - –§—É–Ω–∫—Ü–∏—è `findFolder()` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ª–∏ `trashed=false`?
   - –§—É–Ω–∫—Ü–∏—è `uploadFile()` - —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø–∞–ø–∫—É?
   - `folderCache` - –∫–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–µ—à–∞?

2. **background.js**
   - –§—É–Ω–∫—Ü–∏—è `handleSaveScreenshot()` - –∫–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ—à–∏–±–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–ø–æ–∫?
   - –ï—Å—Ç—å –ª–∏ try-catch –¥–ª—è –æ—à–∏–±–æ–∫ Google Drive API?
   - –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞?

3. **Google Drive API behavior**
   - –ß—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç API –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª –≤ —É–¥–∞–ª–µ–Ω–Ω—É—é –ø–∞–ø–∫—É?
   - –ú–æ–∂–Ω–æ –ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª —É–∫–∞–∑–∞–≤ parentId —É–¥–∞–ª–µ–Ω–Ω–æ–π –ø–∞–ø–∫–∏?

### Known Issues (–Ω–∞ –º–æ–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏)

**Issue 1: Cache Doesn't Validate Folder Existence**
```javascript
// google-drive-api.js:18-21
if (this.folderCache[cacheKey]) {
  console.log(`‚úÖ –ü–∞–ø–∫–∞ "${folderName}" –Ω–∞–π–¥–µ–Ω–∞ –≤ –∫–µ—à–µ`);
  return this.folderCache[cacheKey];
}
```
**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–µ—à –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç ID –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ —á—Ç–æ –ø–∞–ø–∫–∞:
- –°—É—â–µ—Å—Ç–≤—É–µ—Ç
- –ù–µ —É–¥–∞–ª–µ–Ω–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É
- –î–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏

**Issue 2: findFolder() Uses trashed=false but Cache Bypasses It**
```javascript
// google-drive-api.js:23
const query = `name='${folderName}' and mimeType='application/vnd.google-apps.folder' and '${parentId}' in parents and trashed=false`;
```
**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ó–∞–ø—Ä–æ—Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç `trashed=false`
- –ù–û –∫–µ—à –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç ID **–¥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞**
- –ï—Å–ª–∏ –ø–∞–ø–∫–∞ –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞ –ü–û–°–õ–ï –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è ‚Üí –≤–µ—Ä–Ω–µ—Ç—Å—è ID —É–¥–∞–ª–µ–Ω–Ω–æ–π –ø–∞–ø–∫–∏

**Issue 3: No Validation Before File Upload**
```javascript
// google-drive-api.js:108-149 - uploadFile()
```
**–ü—Ä–æ–±–ª–µ–º–∞:**
- –§—É–Ω–∫—Ü–∏—è –ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ `parentFolderId` –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
- Google Drive API **–º–æ–∂–µ—Ç —Ä–∞–∑—Ä–µ—à–∏—Ç—å** –∑–∞–≥—Ä—É–∑–∫—É –≤ —É–¥–∞–ª–µ–Ω–Ω—É—é –ø–∞–ø–∫—É (—Ñ–∞–π–ª –ø–æ–ø–∞–¥–µ—Ç –≤ –∫–æ—Ä–∑–∏–Ω—É)
- –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏

**Issue 4: Silent Failures in Error Handling**
```javascript
// background.js:~380-390 (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ)
if (!fileId) {
  throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç –Ω–∞ Drive –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫");
}
```
**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å ‚Üí –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞
- –ù–æ –¥–∞–ª—å–Ω–µ–π—à–∞—è –ª–æ–≥–∏–∫–∞ (–∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü—ã) –º–æ–∂–µ—Ç **–ù–ï –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø—Ä–æ–±–ª–µ–º–µ

**Issue 5: Zombie Cache Entries**
**–°—Ü–µ–Ω–∞—Ä–∏–π:**
1. –ü–∞–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ ‚Üí ID –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω: `cache["parentId/folderName"] = "abc123"`
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—è–µ—Ç –ø–∞–ø–∫—É –Ω–∞ Drive ‚Üí –ø–∞–ø–∫–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ
3. –ö–µ—à –ù–ï –∑–Ω–∞–µ—Ç –æ–± —É–¥–∞–ª–µ–Ω–∏–∏ ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `"abc123"`
4. –°–∏—Å—Ç–µ–º–∞ –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª ‚Üí –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –∫–æ—Ä–∑–∏–Ω—É –ò–õ–ò –æ—à–∏–±–∫–∞
5. **–ö–µ—à –Ω–µ –æ—á–∏—â–∞–µ—Ç—Å—è** ‚Üí –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è

---

## Technical Requirements

### TR-1: Folder Existence Validation
**–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ:** –ü–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º ID –ø–∞–ø–∫–∏ –∏–∑ –∫–µ—à–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —á—Ç–æ –ø–∞–ø–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –≤ –∫–æ—Ä–∑–∏–Ω–µ.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–∞–ø–∫–∏ —á–µ—Ä–µ–∑ API.

**–î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**
```javascript
// google-drive-api.js
async validateFolder(token, folderId) {
  try {
    const response = await fetch(
      `${this.baseUrl}/files/${folderId}?fields=id,name,trashed,mimeType`,
      {
        headers: { Authorization: `Bearer ${token}` },
      }
    );

    if (!response.ok) {
      if (response.status === 404) {
        console.log(`‚ùå –ü–∞–ø–∫–∞ ${folderId} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (404)`);
        return false;
      }
      throw new Error(`–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞–ø–∫–∏: ${response.status}`);
    }

    const data = await response.json();

    if (data.trashed) {
      console.log(`üóëÔ∏è –ü–∞–ø–∫–∞ ${folderId} –≤ –∫–æ—Ä–∑–∏–Ω–µ`);
      return false;
    }

    if (data.mimeType !== 'application/vnd.google-apps.folder') {
      console.log(`‚ùå ${folderId} –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ø–∞–ø–∫–æ–π`);
      return false;
    }

    console.log(`‚úÖ –ü–∞–ø–∫–∞ ${folderId} (${data.name}) –≤–∞–ª–∏–¥–Ω–∞`);
    return true;
  } catch (error) {
    console.error(`‚ùå –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–∞–ø–∫–∏ ${folderId}:`, error);
    return false;
  }
}
```

### TR-2: Cache Invalidation on Validation Failure
**–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ:** –ï—Å–ª–∏ –ø–∞–ø–∫–∞ –∏–∑ –∫–µ—à–∞ –Ω–µ –ø—Ä–æ—à–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—é ‚Üí —É–¥–∞–ª–∏—Ç—å –∏–∑ –∫–µ—à–∞.

**–î–µ—Ç–∞–ª–∏:**
```javascript
async findFolder(token, folderName, parentId = 'root') {
  const cacheKey = `${parentId}/${folderName}`;

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à
  const cachedId = await this.getCachedFolderId(cacheKey);
  if (cachedId) {
    console.log(`üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ø–∞–ø–∫—É ${cachedId}...`);

    // –ù–û–í–û–ï: –í–∞–ª–∏–¥–∏—Ä—É–µ–º –ø–∞–ø–∫—É
    const isValid = await this.validateFolder(token, cachedId);

    if (isValid) {
      console.log(`‚úÖ –ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–∞–ø–∫–∞ "${folderName}" –≤–∞–ª–∏–¥–Ω–∞`);
      return cachedId;
    } else {
      console.log(`‚ùå –ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–∞–ø–∫–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω–∞, —É–¥–∞–ª—è–µ–º –∏–∑ –∫–µ—à–∞`);
      await this.removeCachedFolderId(cacheKey);
      // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ API
    }
  }

  // –ò—â–µ–º —á–µ—Ä–µ–∑ API...
}

async removeCachedFolderId(cacheKey) {
  await chrome.storage.session.remove(cacheKey);
  console.log(`üóëÔ∏è –£–¥–∞–ª–µ–Ω –∫–µ—à: ${cacheKey}`);
}
```

### TR-3: Pre-Upload Folder Validation
**–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ:** –ü–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π —Ñ–∞–π–ª–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π –ø–∞–ø–∫–∏.

**–î–µ—Ç–∞–ª–∏:**
```javascript
async uploadFile(token, fileName, base64Data, parentFolderId) {
  try {
    // –ù–û–í–û–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞–ø–∫—É –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
    console.log(`üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞–ø–∫—É ${parentFolderId} –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π...`);
    const folderExists = await this.validateFolder(token, parentFolderId);

    if (!folderExists) {
      throw new Error(`–ü–∞–ø–∫–∞ ${parentFolderId} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –≤ –∫–æ—Ä–∑–∏–Ω–µ. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª.`);
    }

    // –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏...
    const blob = this.base64ToBlob(base64Data);
    // ...
  } catch (error) {
    console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ "${fileName}":`, error);
    throw error;
  }
}
```

### TR-4: Error Propagation and User Notification
**–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ:** –û—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–ª–∂–Ω—ã –ø—Ä–µ—Ä—ã–≤–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –∏ –∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–î–µ—Ç–∞–ª–∏:**
```javascript
// background.js - handleSaveScreenshot()
try {
  // ... —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–æ–∫ –∏ –∑–∞–≥—Ä—É–∑–∫–∞

  if (!fileId) {
    throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç –Ω–∞ Drive");
  }

  // ... –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü—ã
} catch (error) {
  console.error("‚ùå [BACKGROUND] –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–Ω—à–æ—Ç–∞:", error);

  // –ù–û–í–û–ï: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ dashboard
  chrome.runtime.sendMessage({
    action: "showError",
    message: `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`
  });

  // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–∞–ª—å—à–µ
  throw error;
}
```

### TR-5: Automatic Cache Clear on Critical Errors
**–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ:** –ü—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö (–ø–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –≤ –∫–æ—Ä–∑–∏–Ω–µ) –æ—á–∏—â–∞—Ç—å –≤–µ—Å—å –∫–µ—à –¥–ª—è —ç—Ç–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞.

**–î–µ—Ç–∞–ª–∏:**
```javascript
async clearCabinetCache(cabinetFolderId) {
  // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫–ª—é—á–∏ –∏–∑ session storage
  const allKeys = await chrome.storage.session.get();

  // –§–∏–ª—å—Ç—Ä—É–µ–º –∫–ª—é—á–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —ç—Ç–∏–º –∫–∞–±–∏–Ω–µ—Ç–æ–º
  const keysToRemove = Object.keys(allKeys).filter(key =>
    key.startsWith(`folder_${cabinetFolderId}/`)
  );

  if (keysToRemove.length > 0) {
    await chrome.storage.session.remove(keysToRemove);
    console.log(`üóëÔ∏è –û—á–∏—â–µ–Ω –∫–µ—à –¥–ª—è –∫–∞–±–∏–Ω–µ—Ç–∞ ${cabinetFolderId}: ${keysToRemove.length} –ø–∞–ø–æ–∫`);
  }
}
```

---

## Implementation Plan

### Phase 1: Pre-Implementation Audit ‚ö†Ô∏è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û
**–¶–µ–ª—å:** –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è.

**–ß–µ–∫-–ª–∏—Å—Ç:**
- [ ] –ü—Ä–æ—á–∏—Ç–∞—Ç—å `google-drive-api.js` - –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –ø–∞–ø–∫–∞–º–∏
- [ ] –ü—Ä–æ—á–∏—Ç–∞—Ç—å `background.js` - handleSaveScreenshot –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Chrome DevTools ‚Üí —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤ —É–¥–∞–ª–µ–Ω–Ω—É—é –ø–∞–ø–∫—É
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Google Drive API documentation - –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ parentId —É–¥–∞–ª–µ–Ω–Ω–æ–π –ø–∞–ø–∫–∏
- [ ] –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –ø—Ä–æ–±–ª–µ–º—É –≤ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö

### Phase 2: Add Folder Validation Function
**–§–∞–π–ª—ã:** `google-drive-api.js`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
1. –î–æ–±–∞–≤–∏—Ç—å `validateFolder(token, folderId)` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–∞–ø–∫–∏
2. –î–æ–±–∞–≤–∏—Ç—å `removeCachedFolderId(cacheKey)` - —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –∫–µ—à–∞
3. –î–æ–±–∞–≤–∏—Ç—å `clearCabinetCache(cabinetFolderId)` - –æ—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ –∫–∞–±–∏–Ω–µ—Ç–∞

### Phase 3: Integrate Validation Into Cache Flow
**–§–∞–π–ª—ã:** `google-drive-api.js`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
1. –û–±–Ω–æ–≤–∏—Ç—å `findFolder()` - –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –ø–∞–ø–∫—É –∏–∑ –∫–µ—à–∞
2. –û–±–Ω–æ–≤–∏—Ç—å `uploadFile()` - –ø—Ä–æ–≤–µ—Ä—è—Ç—å parentFolderId –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π

### Phase 4: Improve Error Handling
**–§–∞–π–ª—ã:** `background.js`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
1. –û–±–µ—Ä–Ω—É—Ç—å `handleSaveScreenshot()` –≤ try-catch —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
2. –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –æ—à–∏–±–æ–∫ –≤ dashboard –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
3. –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø–∞–ø–∫–∏ ‚Üí –≤—ã–∑—ã–≤–∞—Ç—å `clearCabinetCache()`

### Phase 5: Testing
**–°—Ü–µ–Ω–∞—Ä–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**

**Test Case 1: Normal Flow**
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∫–∞–±–∏–Ω–µ—Ç–∞
2. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –°–∫—Ä–∏–Ω—à–æ—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –∑–∞–ø–∏—Å–∏ —Å–æ–∑–¥–∞–Ω—ã

**Test Case 2: Deleted Folder (In Trash)**
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É ‚Üí —É—Å–ø–µ—Ö
2. –£–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É "—Å–∫—Ä–∏–Ω—à–æ—Ç—ã: –∂–∞–ª–æ–±—ã WB" –≤ –∫–æ—Ä–∑–∏–Ω—É (–ù–ï –æ—á–∏—â–∞—Ç—å –∫–æ—Ä–∑–∏–Ω—É)
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å–Ω–æ–≤–∞
4. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   - –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–∞—è –ø–∞–ø–∫–∞
   - –ö–µ—à –æ—á–∏—â–µ–Ω
   - –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –ø–∞–ø–∫–∞
   - –°–∫—Ä–∏–Ω—à–æ—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ –Ω–æ–≤—É—é –ø–∞–ø–∫—É

**Test Case 3: Permanently Deleted Folder**
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É ‚Üí —É—Å–ø–µ—Ö
2. –£–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É "—Å–∫—Ä–∏–Ω—à–æ—Ç—ã: –∂–∞–ª–æ–±—ã WB" –∏ **–æ—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É**
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å–Ω–æ–≤–∞
4. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   - –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–∞–ø–∫–∏ (404)
   - –ö–µ—à –æ—á–∏—â–µ–Ω
   - –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –ø–∞–ø–∫–∞
   - –°–∫—Ä–∏–Ω—à–æ—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã

**Test Case 4: Multiple Retries**
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É ‚Üí —É—Å–ø–µ—Ö
2. –£–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É, –æ—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É (–¥–æ–ª–∂–Ω–∞ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é)
4. –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —à–∞–≥ 2-3 –µ—â–µ 2 —Ä–∞–∑–∞
5. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–∞–∂–¥—ã–π —Ä–∞–∑ —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤–∞—è –ø–∞–ø–∫–∞, —Å–∫—Ä–∏–Ω—à–æ—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è

**Test Case 5: Error Notification**
1. –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É Drive API (–æ—Ç–∫–ª—é—á–∏—Ç—å —Å–µ—Ç—å –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–ø–∫–∏)
2. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ

---

## Acceptance Criteria

‚úÖ **AC-1:** –°–∏—Å—Ç–µ–º–∞ –ù–ï –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª—ã –≤ —É–¥–∞–ª–µ–Ω–Ω—ã–µ –ø–∞–ø–∫–∏ (–∫–æ—Ä–∑–∏–Ω–∞)

‚úÖ **AC-2:** –ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ —É–¥–∞–ª–µ–Ω–Ω–æ–π –ø–∞–ø–∫–∏ –∫–µ—à –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–µ—Ç—Å—è

‚úÖ **AC-3:** –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –∏ –æ—á–∏—Å—Ç–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã –Ω–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é –ø–∞–ø–∫—É

‚úÖ **AC-4:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∑–∞–≥—Ä—É–∑–∫–∏

‚úÖ **AC-5:** –í—Å–µ —Ç–µ—Å—Ç—ã –∏–∑ Phase 5 –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ

---

## Integration with TASK-001

–≠—Ç–∏ –∑–∞–¥–∞—á–∏ **—Ç–µ—Å–Ω–æ —Å–≤—è–∑–∞–Ω—ã** –∏ –¥–æ–ª–∂–Ω—ã —Ä–µ—à–∞—Ç—å—Å—è –≤–º–µ—Å—Ç–µ:

**TASK-001 —Ä–µ—à–∞–µ—Ç:**
- Persistent –∫–µ—à —á–µ—Ä–µ–∑ `chrome.storage.session`
- –î—É–±–ª–∏–∫–∞—Ç—ã –ø–∞–ø–æ–∫ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ service worker

**TASK-002 —Ä–µ—à–∞–µ—Ç:**
- –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞–ø–æ–∫ –∏–∑ –∫–µ—à–∞
- –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–∞–ø–æ–∫
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–û–±—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- –û–±–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `chrome.storage.session` –¥–ª—è –∫–µ—à–∞
- –û–±–∞ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É—é—Ç `findFolder()` –∏ `getOrCreateFolder()`
- –û–±–∞ —Ç—Ä–µ–±—É—é—Ç —É–ª—É—á—à–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±–µ –∑–∞–¥–∞—á–∏ –≤ –æ–¥–Ω–æ–º PR/–∫–æ–º–º–∏—Ç–µ –¥–ª—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ —Ä–µ—à–µ–Ω–∏—è.

---

## Additional Notes

### Google Drive API Behavior
**–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å:** –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞ —Å `parents: ["deleted_folder_id"]`?

–í–æ–∑–º–æ–∂–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:
1. API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 404 - "Parent not found"
2. API —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É - —Ñ–∞–π–ª –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –∫–æ—Ä–∑–∏–Ω—É
3. API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 403 - "Permission denied"

**–¢–µ–∫—É—â–∞—è –≥–∏–ø–æ—Ç–µ–∑–∞:** –°—Ü–µ–Ω–∞—Ä–∏–π 2 (—Ñ–∞–π–ª –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –∫–æ—Ä–∑–∏–Ω—É), –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ —Ä–µ–ø–æ—Ä—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

### Cache Strategy
–ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ TASK-001 + TASK-002:
- –ö–µ—à –±—É–¥–µ—Ç persistent (`chrome.storage.session`)
- –ö–µ—à –±—É–¥–µ—Ç –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
- –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –ø—Ä–∏:
  - –ü–∞–ø–∫–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ (trashed=true)
  - –ü–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ (404)
  - –ü–∞–ø–∫–∞ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ø–∞–ø–∫–æ–π (wrong mimeType)

### User Experience
–î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ü–∏—é –ø—Ä–æ—Ü–µ—Å—Å–∞:
- "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–ø–æ–∫..."
- "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –ø–∞–ø–∫–∏..."
- "‚ö†Ô∏è –ü–∞–ø–∫–∞ –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é..."

---

## Related Files
- `google-drive-api.js` - –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
- `background.js` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- `dashboard.js` - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

## Related Issues
- TASK-001 (Duplicate folders) - **Must be implemented together**

---

**Created by:** AI Assistant
**Last Updated:** 2025-12-01
